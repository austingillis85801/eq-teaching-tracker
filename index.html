<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>EQ Teacher Tracker</title>

  <!-- Manifest (cache-busted so iOS A2HS sticks to /eq-teaching-tracker/) -->
  <link rel="manifest" href="manifest.webmanifest?v=3">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- Added for Chrome/Android PWA notice -->
  <meta name="mobile-web-app-capable" content="yes">
  <!-- Optional favicon (upload favicon.ico to repo root) -->
  <link rel="icon" href="favicon.ico">
  <meta name="apple-mobile-web-app-title" content="EQ Teacher">
  <meta name="theme-color" content="#145AFF">

  <style>
    :root{ --bg:#f7f9fc;--fg:#0b1628;--muted:#657089;--accent:#145AFF;--card:#ffffff;--red:#d44545;--green:#1d9a5b;--amber:#b97a00; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid #e5e8ef;z-index:5}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    nav button{border:1px solid #e5e8ef;background:#fff;border-radius:12px;padding:10px 16px;cursor:pointer;min-height:44px;line-height:1.3;display:inline-flex;align-items:center;justify-content:center}
    nav button.active{background:var(--accent);border-color:var(--accent);color:#fff}
    main{padding-bottom:64px}
    section{display:none}
    section.active{display:block}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .tight-buttons{gap:8px}
    @media (max-width: 600px) {
      .tools .row{flex-direction:column}
      .tools .card{flex:1 1 100%;width:100%}
    }
    .card{background:var(--card);border:1px solid #e5e8ef;border-radius:14px;padding:12px}
    .card h3{margin:0 0 6px 0;font-size:16px}
    .muted{color:var(--muted);font-size:12px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:10px;border:1px solid #ccd3e0;background:#fff;cursor:pointer;min-height:44px;line-height:1.3;position:relative}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.danger{border-color:var(--red);color:#d44545;background:#fff}
    .btn[disabled]{opacity:0.6;cursor:not-allowed}
    .btn.loading{padding-right:34px}
    .btn.loading::after{
      content:"";
      position:absolute;
      right:12px;
      width:14px;
      height:14px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,0.7);
      border-top-color:rgba(11,22,40,0.4);
      animation:spin 0.8s linear infinite;
    }
    .btn.loading.btn:not(.primary)::after{
      border-color:rgba(11,22,40,0.2);
      border-top-color:rgba(11,22,40,0.5);
    }
    input,select,textarea{font-size:16px;padding:8px;border:1px solid #ccd3e0;border-radius:10px;background:#fff; touch-action:manipulation;}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left;vertical-align:top}
    #scheduleTable .section-header th{background:#eef4ff;color:var(--muted);text-transform:uppercase;font-size:11px;letter-spacing:0.05em;border-bottom:1px solid #d9e2ff;text-align:left}
    #scheduleTable .empty td{text-align:center;color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ccd3e0;font-size:12px}
    .pill.green{background:#ebf7f1;border-color:#bde6cf;color:#107a47}
    .pill.red{background:#fdecec;border-color:#f6b1b1;color:#a92d2d}
    .pill.amber{background:#fff4e0;border-color:#ffd69a;color:#8a5a00}
    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));gap:12px}
    .tools{position:static} /* better scrolling on mobile */
    .small{font-size:12px}
    .hidden{display:none}

    @keyframes spin{
      to{transform:rotate(360deg);}
    }

    @media (max-width: 600px){
      .tight-buttons{gap:6px}
      .tight-buttons .btn{
        padding:8px 10px;
        min-height:36px;
        font-size:13px;
        flex:0 1 auto;
        white-space:nowrap;
      }
    }

    /* Screen-reader-only helper for accessible labels */
    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0);
      white-space: nowrap; border: 0;
    }

    /* -------- Responsive schedule table → card rows -------- */
    @media (max-width: 760px){
      #scheduleTable thead{display:none}
      #scheduleTable tr{
        display:block;
        background:#fff;border:1px solid #e5e8ef;border-radius:12px;margin:12px 0;
      }
      #scheduleTable td{
        display:flex;justify-content:space-between;gap:12px;
        padding:10px 12px;border-bottom:1px dashed #eef2f7;
      }
      #scheduleTable td:last-child{border-bottom:0}
      #scheduleTable td::before{
        content:attr(data-label);
        font-weight:600;color:var(--muted);min-width:130px;
      }
      #scheduleTable td .row{flex-wrap:wrap}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>EQ Teacher Tracker</h1>
    <div class="muted small">One teacher per lesson • 2nd & 4th Sundays • Retry after no response: 2 months • Ask cooldown: 2 months (with 6-month snooze)</div>
    <nav id="tabs">
      <button data-tab="nextup" class="active">Next Up</button>
      <button data-tab="schedule">Schedule</button>
      <button data-tab="directory">Directory</button>
      <button data-tab="import">Import/Export</button>
      <button data-tab="settings">Templates & Settings</button>
      <span style="flex:1"></span>
      <span id="userBadge" class="muted small hidden" style="align-self:center"></span>
      <button id="signUpBtn">Create account</button>
      <button id="signInBtn">Sign in</button>
      <button id="signOutBtn" class="hidden">Sign out</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- NEXT UP -->
  <section id="nextup" class="active">
    <div class="tools">
      <div class="row">
        <div class="card" style="flex:1">
          <h3>Recently asked (last 10 days)</h3>
          <div id="recentlyAsked"></div>
        </div>
        <div class="card" style="flex:1">
          <h3>Unassigned upcoming lessons (2nd & 4th Sundays)</h3>
          <div id="unassignedList"></div>
        </div>
      </div>
    </div>
    <div class="grid" id="suggestions"></div>
  </section>

  <!-- SCHEDULE -->
  <section id="schedule">
    <div class="card">
      <h3>Lesson Schedule</h3>
      <table id="scheduleTable">
        <thead><tr><th>Date</th><th>Talk</th><th>Status</th><th>Teacher</th><th>Actions</th></tr></thead>
        <tbody id="scheduleUpcoming"></tbody>
        <tbody id="schedulePast"></tbody>
      </table>
    </div>
  </section>

  <!-- DIRECTORY -->
  <section id="directory">
    <div class="row">
      <div class="card" style="flex:1">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="row" style="gap:8px">
            <!-- Added accessible label -->
            <label for="searchInput" class="sr-only">Search directory</label>
            <input id="searchInput" placeholder="Search name, email, phone digits" />
            <select id="filterSelect">
              <option value="all">All</option>
              <option value="active">Active only</option>
              <option value="noCalling">No calling (eligible)</option>
              <option value="bench">Bench tag</option>
            </select>
            <select id="sortSelect">
              <option value="name">Name (A–Z)</option>
              <option value="lastTaught">Last taught (oldest first)</option>
              <option value="attempts">Attempts (recent asks first)</option>
              <option value="lastAsked">Last asked (oldest first)</option>
            </select>
          </div>
          <div class="muted small" id="dirCount"></div>
        </div>
        <div class="grid" id="directoryGrid"></div>
      </div>
    </div>
  </section>

  <!-- IMPORT / EXPORT -->
  <section id="import">
    <div class="grid">
      <div class="card">
        <h3>Import XLSX/CSV</h3>
        <div class="row">
          <div>
            <label class="small">Upload Teacher Tracker workbook</label><br>
            <input type="file" id="ttFile" accept=".xlsx,.xls,.csv"/>
          </div>
          <div>
            <label class="small">Upload Elders Roster workbook</label><br>
            <input type="file" id="rosterFile" accept=".xlsx,.xls,.csv"/>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="importBtn">Import</button>
          <button class="btn" id="fixDupBtn">Fix Duplicates</button>
          <button class="btn" id="exportBtn">Export CSV</button>
          <button class="btn" id="backupBtn">Backup JSON</button>
          <button class="btn" id="nextLessonsTemplateBtn">Download Next Lessons Template</button>
          <button class="btn" id="cleanNamelessBtn">Remove “(No name)”</button>
        </div>
        <div id="importLog" class="small muted" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <h3>Status</h3>
        <div id="stats"></div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings">
    <div class="grid">
      <div class="card">
        <h3>Message template</h3>
        <div class="muted small" style="margin-bottom:6px">
          Placeholders: <code>{FirstName}</code>, <code>{LastName}</code>, <code>{Date}</code>, <code>{NextTeachSundayPretty}</code>, <code>{TalkTitle}</code>, <code>{TalkSpeaker}</code>, <code>{MeetingTime}</code>.
        </div>
        <textarea id="textTemplate" rows="6" style="width:100%"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="saveTemplateBtn">Save template</button>
          <button class="btn" id="resetTemplateBtn">Reset to default</button>
        </div>
      </div>

      <div class="card">
        <h3>App settings</h3>
        <div class="row" style="gap:12px">
          <label>Meeting time<br><input id="meetingTime" placeholder="e.g., 11:10 AM"></label>
          <label>Ask cooldown (days)<br><input id="askCooldown" type="number" min="0" step="1" style="width:120px"></label>
          <label>Retry after no response (days)<br><input id="retryDays" type="number" min="0" step="1" style="width:120px"></label>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="saveSettingsBtn">Save settings</button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Teacher Picker Modal -->
<div id="picker" class="overlay hidden">
  <div class="modal">
    <div class="hd">
      <strong>Pick a teacher</strong>
      <button class="btn" id="pickerClose">Close</button>
    </div>
    <div class="bd">
      <div class="row" style="margin-bottom:8px">
        <!-- Added accessible label -->
        <label for="pickerSearch" class="sr-only">Search teachers</label>
        <input id="pickerSearch" placeholder="Search name, email, phone…" style="flex:1">
        <label class="small" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="pickerShowCalling"> Show with callings
        </label>
      </div>
      <div id="pickerDate" class="muted small"></div>
      <div id="pickerList" class="list"></div>
    </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase (v10, ESM modules) + App -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { initializeFirestore, persistentLocalCache, collection, doc, getDoc, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  /* ==== YOUR FIREBASE CONFIG ==== */
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAhCxANql5AXYFq8Zi4tDI4Mu2b5AsejUY",
    authDomain: "elders-teaching-assignments.firebaseapp.com",
    projectId: "elders-teaching-assignments",
    storageBucket: "elders-teaching-assignments.firebasestorage.app",
    messagingSenderId: "421405368270",
    appId: "1:421405368270:web:d145de252ea0246dc8959f",
    measurementId: "G-2FJHRTNCLZ"
  };

  // Init
  const app  = initializeApp(FIREBASE_CONFIG);
  const auth = getAuth(app);
  const db   = initializeFirestore(app, { localCache: persistentLocalCache() });

  // Helpers
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const setIf = (id,val)=>{ const el=document.getElementById(id); if(el!=null) el.value=val; };
  function fmtDate(d){ if(!d) return ""; const dt=(d instanceof Date)?d:new Date(d); return dt.toISOString().slice(0,10); }
  function prettyDate(iso){ if(!iso) return ""; const d=new Date(iso+"T12:00:00"); return d.toLocaleDateString(undefined,{weekday:"long", month:"long", day:"numeric"}); }
  function daysSince(d){ if(!d) return 9999; const dt=(d instanceof Date)?d:new Date(d); return Math.floor((Date.now()-dt.getTime())/86400000); }
  function phoneDigits(p){ return (p||"").replace(/\D+/g,""); }
  function keyFrom(name,email,phone){ return [phoneDigits(phone), String(email||"").toLowerCase().trim(), String(name||"").toLowerCase().trim()].join("|"); }
  function escapeHtml(str){
    return String(str||"")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }
  function normalizeName(name){
    if(!name) return "";
    const original=String(name);
    const lower=original.toLowerCase();
    const withoutTitles=lower.replace(/\b(brother|bro\.?)\b/g,"").replace(/\b(sister|sis\.?)\b/g,"").replace(/\b(elder|president|pres\.)\b/g,"");
    const hasComma=original.includes(",");
    let cleaned=withoutTitles.replace(/[\.]/g," ").replace(/,/g," ").replace(/\s+/g," ").trim();
    if(!cleaned) return "";
    let parts=cleaned.split(" ").filter(Boolean);
    if(hasComma && parts.length>=2){
      parts=parts.slice(1).concat(parts[0]);
    }
    const combined=parts.join("");
    return combined.replace(/[^a-z0-9]/g,"");
  }
  function lastNameFrom(full){ if(!full) return ""; const s=String(full).trim(); if(!s) return ""; if(s.includes(",")) return s.split(",")[0].trim(); const parts=s.split(/\s+/); return parts[parts.length-1]||s; }
  function isSecondOrFourthSunday(iso){ const d = new Date(iso+"T12:00:00"); if(d.getDay()!==0) return false; const first=new Date(d.getFullYear(), d.getMonth(), 1); const firstSun=1+((7-first.getDay())%7); const n=Math.floor((d.getDate()-firstSun)/7)+1; return (n===2 || n===4); }
  function sundayLabel(iso){
    const d=new Date(iso+"T12:00:00");
    const first=new Date(d.getFullYear(), d.getMonth(), 1);
    const firstSun=1+((7-first.getDay())%7);
    const n=Math.floor((d.getDate()-firstSun)/7)+1;
    if(n===2) return "Second Sunday";
    if(n===4) return "Fourth Sunday";
    return "";
  }
  function nextLessonDates(existingSet, needed=8){
    const results=[];
    const today=new Date();
    today.setHours(12,0,0,0);
    const seen=new Set();
    let cursor=new Date(today.getFullYear(), today.getMonth(), 1, 12);
    let guard=0;
    while(results.length<needed && guard<120){
      guard++;
      const year=cursor.getFullYear();
      const month=cursor.getMonth();
      const daysInMonth=new Date(year, month+1, 0).getDate();
      for(let day=1; day<=daysInMonth && results.length<needed; day++){
        const dt=new Date(year, month, day, 12);
        if(dt<today) continue;
        if(dt.getDay()!==0) continue;
        const iso=fmtDate(dt);
        if(!isSecondOrFourthSunday(iso)) continue;
        if(existingSet.has(iso)) continue;
        if(seen.has(iso)) continue;
        seen.add(iso);
        results.push({date:iso,label:sundayLabel(iso)});
      }
      cursor.setMonth(cursor.getMonth()+1);
    }
    return results;
  }

  // Tabs
  $$("#tabs button[data-tab]").forEach(b=>b.addEventListener("click",()=>{
    $$("#tabs button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const tab=b.dataset.tab;
    $$("main section").forEach(s=>s.classList.remove("active"));
    const target = $("#"+tab);
    if(target) target.classList.add("active");
  }));

  // Auth UI buttons
  $("#signInBtn").addEventListener("click", async ()=>{
    const email = prompt("Email to sign in:");
    const pass  = prompt("Password:");
    if(!email||!pass) return;
    try{ await signInWithEmailAndPassword(auth, email.trim(), pass); }
    catch(e){ alert("Sign-in failed: " + (e?.message||e)); console.error(e); }
  });

  $("#signUpBtn").addEventListener("click", async ()=>{
    const email = prompt("Create account — email:");
    const pass  = prompt("Create account — password:");
    if(!email||!pass) return;
    try{
      await createUserWithEmailAndPassword(auth, email.trim(), pass);
      await setDoc(doc(db,"users",auth.currentUser.uid,"settings","app"), {
        meetingDay:"Sunday", meetingTime:"11:10 AM",
        askCooldownDays:60, retryNoResponseDays:60,
        textTemplate:"Hey brother {LastName}, this is Austin Gillis from elders quorum. Would you be willing to lead the next elders meeting discussion on {NextTeachSundayPretty}? The presidency has prayed and know you would do amazing if you’re willing."
      }, {merge:true});
      alert("Account created. You're now signed in.");
    }catch(e){ alert("Create account failed: " + (e?.message||e)); console.error(e); }
  });

  $("#signOutBtn").addEventListener("click", ()=>signOut(auth).catch(console.error));

  // State & refs
  let currentUser=null;
  let settings={
    meetingDay:"Sunday",
    meetingTime:"11:10 AM",
    askCooldownDays:60,
    retryNoResponseDays:60,
    textTemplate:"Hey brother {LastName}, this is Austin Gillis from elders quorum. Would you be willing to lead the next elders meeting discussion on {NextTeachSundayPretty}? The presidency has prayed and know you would do amazing if you’re willing."
  };
  let lastValidationSummary=null;

  function renderStatusSummary(summary){
    const container=$("#stats");
    if(!container){ return; }
    if(!summary || (!summary.teacherTracker && !summary.roster)){
      container.innerHTML='<p class="muted small">No imports run yet.</p>';
      return;
    }

    const sections=[];
    if(summary.teacherTracker){
      const tt=summary.teacherTracker;
      const teacherItems=[
        `<li>Rows processed: ${tt.teachers.processed}</li>`,
        `<li>New records: ${tt.teachers.created}</li>`,
        `<li>Updated records: ${tt.teachers.updated}</li>`
      ];
      if(tt.teachers.skippedMissingName){
        teacherItems.push(`<li>Skipped (missing name): ${tt.teachers.skippedMissingName}</li>`);
      }
      if(tt.teachers.errors.length){
        teacherItems.push(`<li>Row issues<ul>${tt.teachers.errors.map(msg=>`<li>${escapeHtml(msg)}</li>`).join("")}</ul></li>`);
      }

      const assignmentItems=[
        `<li>Rows processed: ${tt.assignments.processed}</li>`,
        `<li>New records: ${tt.assignments.created}</li>`,
        `<li>Updated records: ${tt.assignments.updated}</li>`
      ];
      if(tt.assignments.skippedMissingDate){
        assignmentItems.push(`<li>Skipped (invalid date): ${tt.assignments.skippedMissingDate}</li>`);
      }
      if(tt.assignments.errors.length){
        assignmentItems.push(`<li>Row issues<ul>${tt.assignments.errors.map(msg=>`<li>${escapeHtml(msg)}</li>`).join("")}</ul></li>`);
      }

      const ttItems=[
        `<li><strong>Teacher rows</strong><ul>${teacherItems.join("")}</ul></li>`
      ];
      if(tt.assignments.processed || tt.assignments.created || tt.assignments.updated || tt.assignments.skippedMissingDate || tt.assignments.errors.length){
        ttItems.push(`<li><strong>Schedule rows</strong><ul>${assignmentItems.join("")}</ul></li>`);
      }
      if(tt.templateUpdated){
        ttItems.push('<li>Message template updated from workbook</li>');
      }
      if(tt.templateErrors.length){
        ttItems.push(`<li>Template errors<ul>${tt.templateErrors.map(msg=>`<li>${escapeHtml(msg)}</li>`).join("")}</ul></li>`);
      }
      if(tt.fatalError){
        ttItems.push(`<li style="color:var(--red)">${escapeHtml(tt.fatalError)}</li>`);
      }
      sections.push(`<li><strong>Teacher Tracker</strong><ul>${ttItems.join("")}</ul></li>`);
    }

    if(summary.roster){
      const ro=summary.roster;
      const rosterItems=[
        `<li>Rows processed: ${ro.records.processed}</li>`,
        `<li>New records: ${ro.records.created}</li>`,
        `<li>Updated records: ${ro.records.updated}</li>`
      ];
      if(ro.records.skippedMissingName){
        rosterItems.push(`<li>Skipped (missing name): ${ro.records.skippedMissingName}</li>`);
      }
      if(ro.records.errors.length){
        rosterItems.push(`<li>Row issues<ul>${ro.records.errors.map(msg=>`<li>${escapeHtml(msg)}</li>`).join("")}</ul></li>`);
      }
      if(ro.fatalError){
        rosterItems.push(`<li style="color:var(--red)">${escapeHtml(ro.fatalError)}</li>`);
      }
      sections.push(`<li><strong>Roster</strong><ul>${rosterItems.join("")}</ul></li>`);
    }

    container.innerHTML=`<ul class="small" style="margin:0;padding-left:20px">${sections.join("")}</ul>`;
  }

  renderStatusSummary(lastValidationSummary);
  function colTeachers(){ return collection(db,"users",currentUser?.uid,"teachers"); }
  function colAssignments(){ return collection(db,"users",currentUser?.uid,"assignments"); }
  function docSettings(){ return doc(db,"users",currentUser?.uid,"settings","app"); }

  // Settings load/save
  async function loadSettings(){
    const snap=await getDoc(docSettings());
    if(snap.exists()) settings=Object.assign(settings,snap.data());
    setIf("textTemplate", settings.textTemplate);
    setIf("meetingTime", settings.meetingTime);
    setIf("askCooldown", settings.askCooldownDays);
    setIf("retryDays", settings.retryNoResponseDays);
  }
  function bindSettingsButtons(){
    const saveT = $("#saveTemplateBtn");
    const resetT = $("#resetTemplateBtn");
    const saveS = $("#saveSettingsBtn");
    if(saveT) saveT.addEventListener("click", ()=>{
      settings.textTemplate=$("#textTemplate").value.trim();
      setDoc(docSettings(), settings, {merge:true}).then(()=>alert("Template saved."));
    });
    if(resetT) resetT.addEventListener("click", ()=>{
      settings.textTemplate="Hey brother {LastName}, this is Austin Gillis from elders quorum. Would you be willing to lead the next elders meeting discussion on {NextTeachSundayPretty}? The presidency has prayed and know you would do amazing if you’re willing.";
      setIf("textTemplate", settings.textTemplate);
      setDoc(docSettings(), settings, {merge:true});
    });
    if(saveS) saveS.addEventListener("click", ()=>{
      settings.meetingTime=$("#meetingTime").value.trim();
      settings.askCooldownDays=parseInt($("#askCooldown").value,10)||60;
      settings.retryNoResponseDays=parseInt($("#retryDays").value,10)||60;
      setDoc(docSettings(), settings, {merge:true}).then(()=>alert("Settings saved."));
    });
  }

  // Auth listener
  onAuthStateChanged(auth, async (u)=>{
    currentUser=u||null;
    $("#userBadge").textContent = u ? `Signed in as ${u.email||u.uid}` : "";
    $("#userBadge").classList.toggle("hidden", !u);
    $("#signInBtn").classList.toggle("hidden", !!u);
    $("#signUpBtn").classList.toggle("hidden",  !!u);
    $("#signOutBtn").classList.toggle("hidden", !u);

    if(u){
      await loadSettings();
      bindSettingsButtons();
      await renderAll();
    } else {
      $("#recentlyAsked").innerHTML="";
      $("#unassignedList").innerHTML="";
      $("#suggestions").innerHTML="";
      $("#scheduleTable tbody").innerHTML="";
      $("#directoryGrid").innerHTML="";
    }
  });

  // File helpers
  function parseDateFlexible(v){
    if(!v) return null;
    if(v instanceof Date) return v;
    if(typeof v==="number"){ return new Date(Math.round((v-25569)*86400)*1000); } // Excel serial
    const d=new Date(String(v).trim());
    return isNaN(d)? null : d;
  }
  function readFile(file){
    return new Promise((resolve,reject)=>{
      try{
        const name=file.name.toLowerCase();
        const reader=new FileReader();
        reader.onerror=()=> reject(reader.error || new Error(`Failed to read ${file.name}`));
        reader.onload=()=>{
          try{
            const data=reader.result;
            if(name.endsWith(".csv")){
              const res=Papa.parse(data,{header:true,skipEmptyLines:true});
              resolve({type:"csv", sheets:{Sheet1:res.data}});
            } else {
              const wb=XLSX.read(data,{type:"array"}); const sheets={};
              wb.SheetNames.forEach(sn=> sheets[sn]=XLSX.utils.sheet_to_json(wb.Sheets[sn],{defval:null}));
              resolve({type:"xlsx", sheets});
            }
          }catch(err){
            reject(err);
          }
        };
        if(name.endsWith(".csv")) reader.readAsText(file); else reader.readAsArrayBuffer(file);
      }catch(err){
        reject(err);
      }
    });
  }
  async function importTT(obj){
    if(!obj || !obj.sheets){ throw new Error("Teacher Tracker workbook missing sheets."); }

    const summary={
      teachers:{processed:0,created:0,updated:0,skippedMissingName:0,errors:[]},
      assignments:{processed:0,created:0,updated:0,skippedMissingDate:0,errors:[]},
      templateUpdated:false,
      templateErrors:[],
      fatalError:null
    };

    try{
      const sheets=obj.sheets;
      const teacherSheet=sheets["Teacher Tracker"] || sheets["TeacherTracker"] || sheets["Teachers"] || sheets["Sheet1"] || [];
      const findSheet=(names)=>{
        for(const [sheetName, sheet] of Object.entries(sheets||{})){
          if(names.includes((sheetName||"").trim())) return sheet;
        }
        return null;
      };
      const scheduleSheet=findSheet(["Lesson Schedule","Schedule","Next Lessons"]) || [];
      const msgSheet=sheets["Sample Message"] || sheets["Message"] || [];
      const teacherNameLookup=new Map();
      let cachedTeacherNameLookup=null;

      const getTeacherIdForName=async (rawName)=>{
        const norm=normalizeName(rawName);
        if(!norm) return null;
        if(teacherNameLookup.has(norm)) return teacherNameLookup.get(norm);
        if(cachedTeacherNameLookup && cachedTeacherNameLookup.has(norm)) return cachedTeacherNameLookup.get(norm);
        if(!cachedTeacherNameLookup){
          cachedTeacherNameLookup=new Map(teacherNameLookup);
          try{
            const snap=await getDocs(colTeachers());
            snap.forEach(d=>{
              const data=d.data();
              const names=[data?.name];
              for(const nm of names){
                const normName=normalizeName(nm);
                if(normName && !cachedTeacherNameLookup.has(normName)){
                  cachedTeacherNameLookup.set(normName, d.id);
                }
              }
            });
          }catch(err){
            summary.assignments.errors.push(`Lookup failed for \"${rawName}\": ${err?.message||err}`);
            return null;
          }
        }
        return cachedTeacherNameLookup.get(norm)||null;
      };

      if(msgSheet && msgSheet.length){
        const row=msgSheet.find(r=>r.Message)||msgSheet[0];
        if(row && row.Message){
          try{
            settings.textTemplate=String(row.Message).trim();
            await setDoc(docSettings(), settings, {merge:true});
            summary.templateUpdated=true;
          }catch(err){
            summary.templateErrors.push(err?.message||String(err));
          }
        }
      }

      for(let idx=0; idx<teacherSheet.length; idx++){
        const r=teacherSheet[idx];
        summary.teachers.processed++;
        const name=r["Name"] ?? r["PreferredName"] ?? r["Full Name"];
        if(!name){
          summary.teachers.skippedMissingName++;
          continue;
        }
        try{
          const email=r["Email"] ?? r["E-mail"] ?? "";
          const phone=r["Phone"] ?? r["Phone Number"] ?? "";
          const lastAsked=parseDateFlexible(r["Last Asked"]);
          const lastTaught=parseDateFlexible(r["Taught Date"]);
          const willingRaw=(r["Willing to Teach Again?"] ?? r["Willing"] ?? "").toString().toLowerCase();
          const willing=(/^(yes|true|y|1)$/.test(willingRaw)) ? true : (/^(no|false|n|0)$/.test(willingRaw) ? false : null);
          const notes=r["Notes"] ?? "";
          const tags=(r["Tags"]? String(r["Tags"]).split(",").map(s=>s.trim()).filter(Boolean):[]);
          const id=keyFrom(name,email,phone);
          const dref=doc(colTeachers(), id);
          let existed=false;
          try{
            const snap=await getDoc(dref);
            existed=snap.exists();
          }catch{ existed=false; }
          await setDoc(dref, {
            name,email,phone,address:r["Address"] ?? "",
            active:true,hasCalling:false,willingToTeachAgain:willing,
            lastAsked:lastAsked||null,lastTaught:lastTaught||null,
            attemptsSinceLastTaught:r["Attempts"]? Number(r["Attempts"])||0:0,
            responseHistory:[],notes,tags
          },{merge:true});
          if(existed) summary.teachers.updated++; else summary.teachers.created++;
          const variants=[r["Name"], r["PreferredName"], r["Full Name"]].map(v=>v? String(v).trim():"").filter(Boolean);
          for(const variant of variants){
            const norm=normalizeName(variant);
            if(norm && !teacherNameLookup.has(norm)) teacherNameLookup.set(norm,id);
          }
        }catch(err){
          summary.teachers.errors.push(`Row ${idx+1}: ${err?.message||err}`);
        }
      }

      for(let idx=0; idx<scheduleSheet.length; idx++){
        const r=scheduleSheet[idx];
        summary.assignments.processed++;
        const date=parseDateFlexible(r["Date"]);
        if(!date){
          summary.assignments.skippedMissingDate++;
          continue;
        }
        try{
          const iso=fmtDate(date);
          const talkTitle=r["Talk Title"] ?? r["Title"] ?? "";
          const talkSpeaker=r["Talk Speaker"] ?? r["Speaker"] ?? r["General Authority"] ?? "";
          const teacherAssigned=(r["Teacher Assigned"] ?? "").toString().trim();
          const teacherConfirmed=String(r["Teacher Confirmed?"] ?? "").toLowerCase().startsWith("y");
          const status=teacherAssigned ? (teacherConfirmed ? "Confirmed" : "Asked") : "Unassigned";
          const teacherNames=teacherAssigned ? [teacherAssigned] : [];
          let teacherIds=[];
          if(teacherAssigned){
            const resolvedId=await getTeacherIdForName(teacherAssigned);
            if(resolvedId) teacherIds=[resolvedId];
          }
          const dref=doc(colAssignments(), iso);
          let existed=false;
          try{
            const snap=await getDoc(dref);
            existed=snap.exists();
          }catch{ existed=false; }
          await setDoc(dref, {
            date:iso,talkTitle,talkSpeaker,
            teacherIds,
            teacherNames,
            status,askedAt:null,confirmedAt:null,notes:r["Notes"] ?? ""
          }, {merge:true});
          if(existed) summary.assignments.updated++; else summary.assignments.created++;
        }catch(err){
          summary.assignments.errors.push(`Row ${idx+1}: ${err?.message||err}`);
        }
      }
    }catch(err){
      summary.fatalError=err?.message || String(err);
      const error=new Error(`Teacher Tracker import failed: ${summary.fatalError}`);
      error.importType="teacherTracker";
      error.summary=summary;
      throw error;
    }

    return summary;
  }
  async function importRoster(obj){
    if(!obj || !obj.sheets){ throw new Error("Roster workbook missing sheets."); }

    const summary={
      records:{processed:0,created:0,updated:0,skippedMissingName:0,errors:[]},
      fatalError:null
    };

    try{
      const sheets=obj.sheets;
      const rows=sheets["Roster"] || sheets["Sheet2"] || sheets["Sheet1"] || [];
      for(let idx=0; idx<rows.length; idx++){
        const r=rows[idx];
        summary.records.processed++;
        const name=r["Name"] ?? r["PreferredName"] ?? r["Full Name"];
        if(!name){
          summary.records.skippedMissingName++;
          continue;
        }
        try{
          const email=r["E-mail"] ?? r["Email"] ?? "";
          const phone=r["Phone Number"] ?? r["Phone"] ?? "";
          const id=keyFrom(name,email,phone);
          const dref=doc(colTeachers(), id);
          let existed=false;
          try{
            const snap=await getDoc(dref);
            existed=snap.exists();
          }catch{ existed=false; }
          await setDoc(dref, { name,email,phone,address:r["Address"] ?? "", active:true }, {merge:true});
          if(existed) summary.records.updated++; else summary.records.created++;
        }catch(err){
          summary.records.errors.push(`Row ${idx+1}: ${err?.message||err}`);
        }
      }
    }catch(err){
      summary.fatalError=err?.message || String(err);
      const error=new Error(`Roster import failed: ${summary.fatalError}`);
      error.importType="roster";
      error.summary=summary;
      throw error;
    }

    return summary;
  }

  const importControlSelectors=["#importBtn","#fixDupBtn","#exportBtn","#backupBtn","#nextLessonsTemplateBtn","#cleanNamelessBtn"];
  const importControlEls=importControlSelectors.map(sel=>$(sel)).filter(Boolean);
  const importButton=$("#importBtn");

  function setImportLoading(isLoading){
    importControlEls.forEach(el=>{
      if(el) el.disabled=!!isLoading;
    });
    if(importButton){
      importButton.classList.toggle("loading", !!isLoading);
      if(isLoading){
        if(!importButton.dataset.originalText){ importButton.dataset.originalText=importButton.textContent; }
        importButton.textContent="Importing…";
      }else if(importButton.dataset.originalText){
        importButton.textContent=importButton.dataset.originalText;
      }
    }
  }

  function formatImportLog(label, summary){
    if(!summary) return [];
    const lines=[`${label} import summary:`];
    if(summary.teachers && summary.assignments){
      const t=summary.teachers;
      const a=summary.assignments;
      lines.push(`- Teacher rows: processed ${t.processed}, new ${t.created}, updated ${t.updated}, skipped ${t.skippedMissingName}.`);
      if(t.errors.length){
        lines.push("- Teacher row issues:");
        t.errors.forEach(msg=> lines.push(`  • ${msg}`));
      }
      lines.push(`- Schedule rows: processed ${a.processed}, new ${a.created}, updated ${a.updated}, skipped ${a.skippedMissingDate}.`);
      if(a.errors.length){
        lines.push("- Schedule row issues:");
        a.errors.forEach(msg=> lines.push(`  • ${msg}`));
      }
      if(summary.templateUpdated){
        lines.push("- Message template updated from workbook.");
      }
      if(summary.templateErrors?.length){
        lines.push("- Template errors:");
        summary.templateErrors.forEach(msg=> lines.push(`  • ${msg}`));
      }
      if(summary.fatalError){
        lines.push(`- Fatal error: ${summary.fatalError}`);
      }
    } else if(summary.records){
      const r=summary.records;
      lines.push(`- Records: processed ${r.processed}, new ${r.created}, updated ${r.updated}, skipped ${r.skippedMissingName}.`);
      if(r.errors.length){
        lines.push("- Row issues:");
        r.errors.forEach(msg=> lines.push(`  • ${msg}`));
      }
      if(summary.fatalError){
        lines.push(`- Fatal error: ${summary.fatalError}`);
      }
    }
    return lines;
  }

  function summaryMutated(summary){
    if(!summary) return false;
    if(summary.teachers && summary.assignments){
      return !!(summary.teachers.created || summary.teachers.updated || summary.assignments.created || summary.assignments.updated || summary.templateUpdated);
    }
    if(summary.records){
      return !!(summary.records.created || summary.records.updated);
    }
    return false;
  }

  // Import/Export / Cleanup buttons
  $("#importBtn").addEventListener("click", async()=>{
    if(!currentUser) return alert("Sign in first.");
    const logEl=$("#importLog");
    const ttF=$("#ttFile").files[0];
    const roF=$("#rosterFile").files[0];
    if(!ttF && !roF){
      logEl.textContent="Select at least one file to import.";
      return;
    }

    const logLines=[];
    const summaryBundle={teacherTracker:null, roster:null};
    let shouldRefresh=false;

    setImportLoading(true);
    logEl.textContent="Import in progress…";

    try{
      if(ttF){
        logLines.push(`Reading ${ttF.name}…`);
        const data=await readFile(ttF);
        logLines.push("Processing Teacher Tracker workbook…");
        const ttSummary=await importTT(data);
        summaryBundle.teacherTracker=ttSummary;
        shouldRefresh = shouldRefresh || summaryMutated(ttSummary);
        logLines.push(...formatImportLog("Teacher Tracker", ttSummary));
      }
      if(roF){
        logLines.push(`Reading ${roF.name}…`);
        const data2=await readFile(roF);
        logLines.push("Processing Roster workbook…");
        const rosterSummary=await importRoster(data2);
        summaryBundle.roster=rosterSummary;
        shouldRefresh = shouldRefresh || summaryMutated(rosterSummary);
        logLines.push(...formatImportLog("Roster", rosterSummary));
      }
      logEl.textContent=logLines.join("\n");
    }catch(err){
      const message=err?.message || String(err);
      logLines.push(message);
      if(err.summary && err.importType){
        summaryBundle[err.importType]=err.summary;
        shouldRefresh = shouldRefresh || summaryMutated(err.summary);
        const label=err.importType==="teacherTracker"?"Teacher Tracker":"Roster";
        logLines.push(...formatImportLog(label, err.summary));
      }
      logEl.textContent=logLines.join("\n");
      console.error(err);
    }finally{
      setImportLoading(false);
      if(summaryBundle.teacherTracker || summaryBundle.roster){
        lastValidationSummary=summaryBundle;
      }
      renderStatusSummary(lastValidationSummary);
      if(shouldRefresh){
        renderAll();
      }
    }
  });
  $("#fixDupBtn").addEventListener("click", ()=> alert("Duplicates prevented via deterministic IDs."));
  $("#exportBtn").addEventListener("click", async()=>{
    if(!currentUser) return alert("Sign in first.");
    const rows=[]; const snap=await getDocs(colTeachers());
    snap.forEach(d=>{
      const t=d.data();
      rows.push({
        Name:t.name, Email:t.email, Phone:t.phone, Address:t.address, Active:t.active,
        HasCalling:t.hasCalling, WillingToTeachAgain:t.willingToTeachAgain,
        LastAsked: t.lastAsked? fmtDate(t.lastAsked.toDate? t.lastAsked.toDate(): t.lastAsked):"",
        LastTaught: t.lastTaught? fmtDate(t.lastTaught.toDate? t.lastTaught.toDate(): t.lastTaught):"",
        Attempts: t.attemptsSinceLastTaught||0, Notes:t.notes||"", Tags:(t.tags||[]).join(",")
      });
    });
    const csv=Papa.unparse(rows);
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob); a.download="teachers_export.csv"; a.click();
  });
  $("#backupBtn").addEventListener("click", async()=>{
    if(!currentUser) return alert("Sign in first.");
    const teachers=[]; const tSnap=await getDocs(colTeachers()); tSnap.forEach(d=>teachers.push({id:d.id,...d.data()}));
    const assigns=[]; const aSnap=await getDocs(colAssignments()); aSnap.forEach(d=>assigns.push({id:d.id,...d.data()}));
    const payload=JSON.stringify({settings, teachers, assignments:assigns}, null, 2);
    const blob=new Blob([payload],{type:"application/json"}); const a=document.createElement("a");
    a.href=URL.createObjectURL(blob); a.download="backup.json"; a.click();
  });
  $("#nextLessonsTemplateBtn").addEventListener("click", async()=>{
    if(!currentUser) return alert("Sign in first.");
    const assignments=await fetchAssignments();
    const existing=new Set(assignments.map(a=>a.date));
    const upcoming=nextLessonDates(existing, 8);
    if(!upcoming.length){
      $("#importLog").textContent="All upcoming 2nd/4th Sundays already scheduled.";
      alert("Nothing new to add — all upcoming 2nd/4th Sundays are on the schedule.");
      return;
    }
    const columns=["Date","Talk Title","Talk Speaker","Teacher Assigned","Teacher Confirmed?","Notes"];
    const rows=upcoming.map(item=>({
      "Date":item.date,
      "Talk Title":"",
      "Talk Speaker":"",
      "Teacher Assigned":"",
      "Teacher Confirmed?":"",
      "Notes":item.label
    }));
    const worksheet=XLSX.utils.json_to_sheet(rows,{header:columns});
    const workbook=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Next Lessons");
    const wbout=XLSX.write(workbook,{bookType:"xlsx",type:"array"});
    const blob=new Blob([wbout],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="next_lessons_template.xlsx";
    a.click();
    $("#importLog").textContent=`Created template with ${rows.length} upcoming lessons.`;
  });
  $("#cleanNamelessBtn").addEventListener("click", async()=>{
    if(!currentUser) return alert("Sign in first.");
    if(!confirm('Remove all teacher records that have no "name"?')) return;
    let removed=0;
    const snap=await getDocs(colTeachers());
    for (const d of snap.docs){
      const t=d.data();
      if(!t.name || !String(t.name).trim()){
        await deleteDoc(doc(colTeachers(), d.id));
        removed++;
      }
    }
    alert(`Removed ${removed} nameless record(s).`);
    renderAll();
  });

  // Data fetchers
  async function fetchTeachers(){ const arr=[]; const snap=await getDocs(colTeachers()); snap.forEach(d=>arr.push({id:d.id,...d.data()})); return arr; }
  async function fetchAssignments(){ const arr=[]; const snap=await getDocs(colAssignments()); snap.forEach(d=>arr.push({id:d.id,...d.data()})); return arr.sort((a,b)=>a.date.localeCompare(b.date)); }

  // Eligibility/scoring
  function eligibleTeacher(t){
    if(!t || !t.name || !String(t.name).trim()) return false;
    if(!t.active) return false;
    if(t.hasCalling) return false;
    if(t.willingToTeachAgain===false) return false;
    if(t.snoozeUntil){
      const s=t.snoozeUntil.toDate ? t.snoozeUntil.toDate() : new Date(t.snoozeUntil);
      if(s>new Date()) return false;
    }
    const cool=settings.askCooldownDays;
    if(t.lastAsked){
      const la=t.lastAsked.toDate? t.lastAsked.toDate(): new Date(t.lastAsked);
      if(daysSince(la) < cool) return false;
    }
    return true;
  }
  function teacherScore(t, meetingIso){
    let score=0;
    const never=!t.lastTaught;
    score += never ? 180 : daysSince(t.lastTaught?.toDate? t.lastTaught.toDate(): t.lastTaught);
    score += (t.attemptsSinceLastTaught||0)*2;
    if(t.tags && t.tags.includes("Bench")){
      const daysTo=Math.floor((new Date(meetingIso).getTime()-Date.now())/86400000);
      if(daysTo<=7) score += 15;
    }
    return score;
  }

  // Renders
  async function renderNextUp(){
    const [teachers, assignments] = await Promise.all([fetchTeachers(), fetchAssignments()]);
    const teacherMap=new Map(teachers.map(t=>[t.id,t]));
    const recent = teachers
      .filter(t=>t && t.name)
      .map(t=>({t, ds: t.lastAsked ? daysSince(t.lastAsked.toDate? t.lastAsked.toDate():t.lastAsked):9999}))
      .filter(x=>x.ds<=10).sort((a,b)=>a.ds-b.ds).slice(0,30);

    $("#recentlyAsked").innerHTML = recent.length ? recent.map(x=>{
      const t=x.t;
      return `<div class="row" style="align-items:center;justify-content:space-between;border-bottom:1px dashed #eef2f7;padding:6px 0">
        <div><b>${t.name}:</b> asked ${x.ds}d ago</div>
        <div class="row tight-buttons">
          <button class="btn" onclick="markResponse('${t.id}','Accepted')">Confirm</button>
          <button class="btn" onclick="markResponse('${t.id}','Declined')">Declined</button>
          <button class="btn danger" onclick="markResponse('${t.id}','NoResponse')">No response</button>
        </div>
      </div>`;
    }).join("") : `<div class="muted small">No one asked in the last 10 days.</div>`;

    const upcoming = assignments
      .filter(a=> isSecondOrFourthSunday(a.date) && (a.status==="Unassigned" || !((a.teacherIds&&a.teacherIds.length)||(a.teacherNames&&a.teacherNames.length))))
      .slice(0,8);

    $("#unassignedList").innerHTML = upcoming.length ? upcoming.map(a=>{
      const talkDisplay = (a.talkSpeaker && a.talkTitle) ? `${a.talkSpeaker} — ${a.talkTitle}` : (a.talkTitle || a.talkSpeaker || "");
      const pendingFromIds=(a.pendingTeacherIds||[]).map(id=>{
        const raw=teacherMap.get(id)?.name;
        const clean=raw && String(raw).trim();
        return clean || id;
      });
      const pendingNamesRaw=[...new Set([...(pendingFromIds||[]), ...((a.pendingTeacherNames||[]).map(n=> String(n||"").trim()))])];
      const pendingNames=pendingNamesRaw.map(n=> String(n||"").trim()).filter(Boolean);
      const pendingHtml=pendingNames.length ? `<div class="muted small">Pending: ${pendingNames.join(", ")}</div>` : "";
      return `<div class="row" style="align-items:center;justify-content:space-between;border-bottom:1px dashed #eef2f7;padding:6px 0">
        <div>
          <div><b>${a.date}</b> — ${talkDisplay||"(No title)"}</div>
          ${pendingHtml}
        </div>
        <div class="row tight-buttons">
          <button class="btn primary" onclick="suggestTeacherFor('${a.id}','${a.date}')">Suggest teacher</button>
          <button class="btn" onclick="openTeacherPicker('${a.id}')">Pick teacher</button>
        </div>
      </div>`;
    }).join("") : `<div class="muted small">No unassigned 2nd/4th Sundays found.</div>`;

    const next = upcoming[0];
    if(!next){ $("#suggestions").innerHTML=""; return; }
    const elig=teachers.filter(eligibleTeacher);
    elig.sort((a,b)=> teacherScore(b, next.date) - teacherScore(a, next.date));
    const top=elig.slice(0,6);
    $("#suggestions").innerHTML = top.map(t=>{
      const lastT=t.lastTaught? fmtDate(t.lastTaught?.toDate ? t.lastTaught.toDate(): t.lastTaught) : "—";
      const lastA=t.lastAsked? fmtDate(t.lastAsked?.toDate ? t.lastAsked.toDate(): t.lastAsked) : "—";
      const bench=(t.tags||[]).includes("Bench")? `<span class="pill green" style="margin-left:6px">Bench</span>`:"";
      return `<div class="card">
        <h3>${t.name} ${bench}</h3>
        <div class="muted small">Last taught: ${lastT} • Last asked: ${lastA}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" onclick="askTeacher('${t.id}','${next.id}')">Ask for ${next.date}</button>
          <button class="btn" onclick="toggleHasCalling('${t.id}', true)">Has calling</button>
          <button class="btn" onclick="toggleSnooze('${t.id}')">${isSnoozed(t) ? "Unsnooze" : "Snooze 6mo"}</button>
        </div>
      </div>`;
    }).join("");
  }

  function isSnoozed(t){
    if(!t || !t.snoozeUntil) return false;
    const s = t.snoozeUntil.toDate ? t.snoozeUntil.toDate() : new Date(t.snoozeUntil);
    return s > new Date();
  }

  async function renderSchedule(){
    const [teachers, assignments] = await Promise.all([fetchTeachers(), fetchAssignments()]);
    const tMap=new Map(teachers.map(t=>[t.id,t]));
    const upcomingBody=$("#scheduleUpcoming");
    const pastBody=$("#schedulePast");
    upcomingBody.innerHTML="";
    pastBody.innerHTML="";

    const today=new Date();
    const todayMid=new Date(today.getFullYear(), today.getMonth(), today.getDate(), 12, 0, 0, 0);

    const buckets={
      upcoming:[],
      past:[]
    };

    for(const a of assignments){
      const lessonDate=new Date(`${a.date}T12:00:00`);
      const time=lessonDate.valueOf();
      if(!Number.isNaN(time) && lessonDate < todayMid){
        buckets.past.push({assignment:a, lessonDate, time});
      }else{
        buckets.upcoming.push({assignment:a, lessonDate, time});
      }
    }

    const upcomingSortValue=item=> Number.isFinite(item.time) ? item.time : Number.POSITIVE_INFINITY;
    const pastSortValue=item=> Number.isFinite(item.time) ? item.time : Number.NEGATIVE_INFINITY;
    buckets.upcoming.sort((a,b)=> upcomingSortValue(a) - upcomingSortValue(b));
    buckets.past.sort((a,b)=> pastSortValue(b) - pastSortValue(a));

    const renderRows=(list, tbody, title, emptyMessage)=>{
      const header=document.createElement("tr");
      header.className="section-header";
      header.innerHTML=`<th colspan="5">${title}</th>`;
      tbody.appendChild(header);
      if(list.length){
        for(const {assignment:a} of list){
          const namesId=(a.teacherIds||[]).map(id=> tMap.get(id)?.name || id);
          const names=(namesId.length? namesId : (a.teacherNames||[]));
          const pendingFromIds=(a.pendingTeacherIds||[]).map(id=>{
            const raw=tMap.get(id)?.name;
            const clean=raw && String(raw).trim();
            return clean || id;
          });
          const pendingNamesRaw=[...new Set([...(pendingFromIds||[]), ...((a.pendingTeacherNames||[]).map(n=> String(n||"").trim()))])];
          const pendingNames=pendingNamesRaw.map(n=> String(n||"").trim()).filter(Boolean);
          const pendingHtml=pendingNames.length ? `<div class="muted small">Pending: ${pendingNames.join(", ")}</div>` : "";
          const warn=isSecondOrFourthSunday(a.date)? "": "<span class='pill amber'>⚠</span>";
          const isDone = a.status==="Completed";
          const talkDisplay = (a.talkSpeaker && a.talkTitle) ? `${a.talkSpeaker} — ${a.talkTitle}` : (a.talkTitle || a.talkSpeaker || "");
          const hasTeacher = ((a.teacherIds&&a.teacherIds.length) || (a.teacherNames&&a.teacherNames.length));

          const tr=document.createElement("tr");
          tr.innerHTML = `
            <td data-label="Date">${a.date} ${warn}</td>
            <td data-label="Talk">${talkDisplay||"—"}</td>
            <td data-label="Status">${a.status||"Unassigned"}</td>
            <td data-label="Teacher"><div>${(names||[]).join(", ")||"—"}</div>${pendingHtml}</td>
            <td data-label="Actions">
              <div class="row tight-buttons">
                <button class="btn" onclick="quickAssign('${a.id}')">Suggest</button>
                <button class="btn" onclick="openTeacherPicker('${a.id}')">Pick</button>
                <button class="btn" onclick="toggleCompleted('${a.id}')">${isDone?"Undo completed":"Mark completed"}</button>
                ${hasTeacher ? `<button class="btn danger" onclick="unassign('${a.id}')">Unassign</button>` : ""}
              </div>
            </td>`;
          tbody.appendChild(tr);
        }
      }else{
        const empty=document.createElement("tr");
        empty.className="empty";
        empty.innerHTML=`<td data-label="" colspan="5">${emptyMessage}</td>`;
        tbody.appendChild(empty);
      }
    };

    renderRows(buckets.upcoming, upcomingBody, "Upcoming lessons", "No upcoming lessons");
    renderRows(buckets.past, pastBody, "Past lessons", "No past lessons");
  }

  async function renderDirectory(){
    const teachers=await fetchTeachers();
    const q=$("#searchInput").value.trim().toLowerCase();
    const filter=$("#filterSelect").value;
    const sort=$("#sortSelect").value;

    let arr=teachers.slice().filter(t=> t && t.name && String(t.name).trim());

    arr = arr.filter(t=>{
      if(filter==="active" && !t.active) return false;
      if(filter==="noCalling" && t.hasCalling) return false;
      if(filter==="bench" && !(t.tags||[]).includes("Bench")) return false;
      const hay=[t.name||"", t.email||"", phoneDigits(t.phone||"")].join(" ").toLowerCase();
      return hay.includes(q);
    });

    arr.sort((a,b)=>{
      if(sort==="name") return (a.name||"").localeCompare(b.name||"");
      if(sort==="lastTaught") return daysSince(b.lastTaught?.toDate? b.lastTaught.toDate():b.lastTaught||0) - daysSince(a.lastTaught?.toDate? a.lastTaught.toDate():a.lastTaught||0);
      if(sort==="attempts") return (b.attemptsSinceLastTaught||0)-(a.attemptsSinceLastTaught||0);
      if(sort==="lastAsked") return daysSince(b.lastAsked?.toDate? b.lastAsked.toDate():b.lastAsked||0) - daysSince(a.lastAsked?.toDate? a.lastAsked.toDate():a.lastAsked||0);
      return 0;
    });

    $("#dirCount").textContent=`${arr.length} teachers`;

    $("#directoryGrid").innerHTML = arr.map(t=>{
      const lastT=t.lastTaught? fmtDate(t.lastTaught?.toDate? t.lastTaught.toDate(): t.lastTaught):"—";
      const lastA=t.lastAsked? fmtDate(t.lastAsked?.toDate? t.lastAsked.toDate(): t.lastAsked):"—";
      const bench=(t.tags||[]).includes("Bench")? `<span class="pill green" style="margin-left:6px">Bench</span>`:"";
      const calling=t.hasCalling? `<span class="pill amber" style="margin-left:6px">Has calling</span>`:"";
      const unwilling=(t.willingToTeachAgain===false)? `<span class="pill red" style="margin-left:6px">Not willing</span>`:"";
      const willingBtn=(t.willingToTeachAgain===false)
        ? `<button class="btn" onclick="setWilling('${t.id}', true)">Set willing</button>`
        : `<button class="btn" onclick="setWilling('${t.id}', false)">Set not willing</button>`;
      const snoozeBtn = `<button class="btn" onclick="toggleSnooze('${t.id}')">${isSnoozed(t) ? "Unsnooze" : "Snooze 6mo"}</button>`;

      return `<div class="card">
        <h3>${t.name} ${bench} ${calling} ${unwilling}</h3>
        <div class="muted small">Last taught: ${lastT} • Last asked: ${lastA}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="openAskForTeacher('${t.id}')">Ask…</button>
          <button class="btn" onclick="toggleHasCalling('${t.id}', ${!t.hasCalling})">${t.hasCalling?"Clear calling":"Has calling"}</button>
          <button class="btn" onclick="toggleBench('${t.id}', ${!(t.tags||[]).includes("Bench")})">${(t.tags||[]).includes("Bench")?"Remove Bench":"Add Bench"}</button>
          ${willingBtn}
          ${snoozeBtn}
        </div>
      </div>`;
    }).join("");
  }

  // Live directory filters
  $("#searchInput").addEventListener("input", renderDirectory);
  $("#filterSelect").addEventListener("change", renderDirectory);
  $("#sortSelect").addEventListener("change", renderDirectory);

  // Quick actions (refresh all views so Next Up updates immediately)
  window.toggleHasCalling = async(id,val)=>{ await setDoc(doc(colTeachers(),id), {hasCalling:!!val}, {merge:true}); await renderAll(); };
  window.setWilling = async(id,makeWilling)=>{ await setDoc(doc(colTeachers(),id), {willingToTeachAgain: !!makeWilling}, {merge:true}); await renderAll(); };
  window.toggleBench = async(id,add)=>{
    const dref=doc(colTeachers(),id); const snap=await getDoc(dref); if(!snap.exists()) return;
    const t=snap.data(); const tags=new Set(t.tags||[]); if(add) tags.add("Bench"); else tags.delete("Bench");
    await setDoc(dref, {tags:Array.from(tags)}, {merge:true}); await renderAll();
  };
  window.toggleSnooze = async(id)=>{
    const dref=doc(colTeachers(),id); const snap=await getDoc(dref); if(!snap.exists()) return;
    const t=snap.data();
    if(isSnoozed(t)){ await setDoc(dref, {snoozeUntil:null}, {merge:true}); }
    else{ const until=new Date(Date.now()+180*86400000); await setDoc(dref, {snoozeUntil:until}, {merge:true}); }
    await renderAll();
  };
  window.suggestTeacherFor = async(assignId, iso)=>{
    const teachers=await fetchTeachers();
    const elig=teachers.filter(t=>eligibleTeacher(t));
    elig.sort((a,b)=> teacherScore(b, iso) - teacherScore(a, iso));
    const top=elig[0];
    if(!top) return alert("No eligible teachers right now.");
    alert("Top suggestion for "+iso+": "+(top.name||top.id));
    renderAll();
  };
  window.quickAssign = async(assignmentId)=>{
    const aSnap=await getDoc(doc(colAssignments(), assignmentId)); if(!aSnap.exists()) return;
    const a=aSnap.data();
    await suggestTeacherFor(assignmentId, a.date);
  };

  // SMS template
  function buildSmsBody(name,dateIso,title,speaker){
    const ln = lastNameFrom(name);
    const pretty = prettyDate(dateIso) || "";
    const first = String(name||"").trim().split(/\s+/)[0] || "";
    return (settings.textTemplate||"")
      .replaceAll("{FirstName}", first)
      .replaceAll("{LastName}", ln)
      .replaceAll("{Date}", dateIso||"")
      .replaceAll("{NextTeachSundayPretty}", pretty)
      .replaceAll("{TalkTitle}", title||"")
      .replaceAll("{TalkSpeaker}", speaker||"")
      .replaceAll("{MeetingTime}", settings.meetingTime||"");
  }

  window.askTeacher = async(teacherId, assignmentId)=>{
    const aRef = doc(colAssignments(), assignmentId);
    const aSnap=await getDoc(aRef); if(!aSnap.exists()) return alert("Assignment not found.");
    const a=aSnap.data(); const tSnap=await getDoc(doc(colTeachers(), teacherId)); if(!tSnap.exists()) return alert("Teacher not found.");
    const t=tSnap.data(); const now=new Date();
    const cleanName=(t.name && String(t.name).trim()) ? String(t.name).trim() : "";
    const pendingName=cleanName || teacherId;
    const nextPendingIds=Array.from(new Set([...(a.pendingTeacherIds||[]), teacherId]));
    const existingPendingNames=(a.pendingTeacherNames||[]).map(n=> String(n||"").trim()).filter(Boolean);
    const nextPendingNames=existingPendingNames.includes(pendingName)
      ? existingPendingNames
      : existingPendingNames.concat([pendingName]);
    await setDoc(doc(colTeachers(), teacherId), { lastAsked: now, attemptsSinceLastTaught: (t.attemptsSinceLastTaught||0)+1, noResponseFlag:false }, {merge:true});
    await setDoc(aRef, { pendingTeacherIds: nextPendingIds, pendingTeacherNames: nextPendingNames }, {merge:true});
    const body=encodeURIComponent(buildSmsBody(t.name, a.date, a.talkTitle, a.talkSpeaker));
    const phone=phoneDigits(t.phone||"");
    const smsHref = phone ? `sms:${phone}?&body=${body}` : `sms:?&body=${body}`;
    window.location.href=smsHref;
    renderAll();
  };

  window.openAskForTeacher = async(teacherId)=>{
    const tSnap = await getDoc(doc(colTeachers(), teacherId));
    const teacherName = tSnap.exists() ? String(tSnap.data().name||"").trim() : "";
    const assigns=await fetchAssignments();
    const target=assigns.find(x=>{
      if(!isSecondOrFourthSunday(x.date)) return false;
      const hasTeacher=((x.teacherIds&&x.teacherIds.length)||(x.teacherNames&&x.teacherNames.length));
      const pendingIds=x.pendingTeacherIds||[];
      const pendingNames=(x.pendingTeacherNames||[]).map(n=> String(n||"").trim());
      const teacherMatch=pendingIds.includes(teacherId) || pendingNames.includes(teacherId) || (teacherName && pendingNames.includes(teacherName));
      const status=(x.status||"Unassigned");
      return (!hasTeacher && status==="Unassigned" && !teacherMatch);
    });
    if(!target) return alert("No unassigned lesson found."); await askTeacher(teacherId, target.id);
  };

  // "No response" works even if assignment only stored names
  window.markResponse = async(teacherId, type)=>{
    const now=new Date();
    const tSnap=await getDoc(doc(colTeachers(), teacherId)); if(!tSnap.exists()) return;
    const t=tSnap.data();
    const assigns=await fetchAssignments();
    const teacherName=(t.name && String(t.name).trim()) ? String(t.name).trim() : "";
    const findMatch=(list, nameList)=>{
      if((list||[]).includes(teacherId)) return true;
      const cleanedNames=(nameList||[]).map(n=> String(n||"").trim());
      if(teacherName && cleanedNames.includes(teacherName)) return true;
      return cleanedNames.includes(teacherId);
    };
    let a=assigns.find(x=> findMatch(x.pendingTeacherIds, x.pendingTeacherNames));
    if(!a){
      a=assigns.find(x=> findMatch(x.teacherIds, x.teacherNames));
    }
    const aRef = a ? doc(colAssignments(), a.id) : null;
    const pendingNameKey = teacherName || teacherId;
    const prunePending = (assignment)=>{
      if(!assignment) return {ids:[], names:[]};
      const ids=(assignment.pendingTeacherIds||[]).filter(id=>id!==teacherId);
      const names=(assignment.pendingTeacherNames||[])
        .map(n=> String(n||"").trim())
        .filter(name=> name !== pendingNameKey && name !== teacherId);
      return {ids, names};
    };
    const askedAtValue = a?.askedAt || now;

    if(type==="Accepted"){
      if(a && aRef){
        const {ids, names}=prunePending(a);
        await setDoc(aRef, {
          status:"Confirmed",
          askedAt: askedAtValue,
          confirmedAt: now,
          teacherIds:[teacherId],
          teacherNames:[pendingNameKey],
          pendingTeacherIds: ids,
          pendingTeacherNames: names
        }, {merge:true});
      }
      alert("Marked as confirmed.");
    } else if(type==="Declined"){
      if(a && aRef){
        const {ids, names}=prunePending(a);
        await setDoc(aRef, {
          status:"Unassigned",
          teacherIds:[],
          teacherNames:[],
          askedAt:null,
          confirmedAt:null,
          pendingTeacherIds: ids,
          pendingTeacherNames: names
        }, {merge:true});
      }
      await setDoc(doc(colTeachers(), teacherId), { lastAsked: now }, {merge:true});
      alert("Marked as declined and slot reopened.");
    } else if(type==="NoResponse"){
      await setDoc(doc(colTeachers(), teacherId), { noResponseFlag:true, noResponseAt:now }, {merge:true});
      if(a && aRef){
        const {ids, names}=prunePending(a);
        await setDoc(aRef, {
          status:"Unassigned",
          teacherIds:[],
          teacherNames:[],
          askedAt:null,
          confirmedAt:null,
          pendingTeacherIds: ids,
          pendingTeacherNames: names
        }, {merge:true});
      }
      alert("Logged as no response and put back in queue.");
    }
    renderAll();
  };

  // Toggle completed (aware of name-only assignments)
  window.toggleCompleted = async(assignmentId)=>{
    const aRef = doc(colAssignments(), assignmentId);
    const aSnap = await getDoc(aRef); if(!aSnap.exists()) return;
    const a = aSnap.data();
    const hasTeacher = ((a.teacherIds&&a.teacherIds.length) || (a.teacherNames&&a.teacherNames.length));
    if(a.status==="Completed"){
      let newStatus = "Unassigned";
      if(hasTeacher){
        if(a.confirmedAt) newStatus="Confirmed";
        else if(a.askedAt) newStatus="Asked";
        else newStatus="Unassigned";
      }
      const update={status:newStatus};
      if(newStatus==="Unassigned"){ update.pendingTeacherIds=[]; update.pendingTeacherNames=[]; }
      await setDoc(aRef, update, {merge:true});
    } else {
      await setDoc(aRef, {status:"Completed", pendingTeacherIds:[], pendingTeacherNames:[]}, {merge:true});
      const teacherId=(a.teacherIds||[])[0];
      if(teacherId){
        await setDoc(doc(colTeachers(), teacherId), { lastTaught:new Date(), attemptsSinceLastTaught:0 }, {merge:true});
      }
    }
    renderSchedule();
  };

  // Unassign clears both ids and names and resets status
  window.unassign = async(assignmentId)=>{
    const aRef = doc(colAssignments(), assignmentId);
    await setDoc(aRef, {teacherIds:[], teacherNames:[], status:"Unassigned", askedAt:null, confirmedAt:null, pendingTeacherIds:[], pendingTeacherNames:[]}, {merge:true});
    renderAll();
  };

  // Picker
  window.openTeacherPicker = (assignmentId)=>{
    pickerState.assignmentId = assignmentId;
    const el = document.getElementById("picker");
    const dEl = document.getElementById("pickerDate");
    (async ()=>{
      const aSnap = await getDoc(doc(colAssignments(), assignmentId));
      const a = aSnap.exists() ? aSnap.data() : {date:""};
      pickerState.dateIso = a.date || "";
      dEl.textContent = a.date ? `Assigning for ${a.date}` : "";
      pickerState.teachers = await fetchTeachers();
      renderPickerList();
      el.classList.remove("hidden");
      const ps = document.getElementById("pickerSearch");
      setTimeout(()=> ps && ps.focus({preventScroll:true}), 150);
    })();
  };

  let pickerState = { assignmentId: null, dateIso: null, teachers: [] };
  function closeTeacherPicker(){
    document.getElementById("picker").classList.add("hidden");
    pickerState = { assignmentId: null, dateIso: null, teachers: [] };
  }
  document.getElementById("pickerClose").addEventListener("click", closeTeacherPicker);
  document.getElementById("pickerSearch").addEventListener("input", renderPickerList);
  document.getElementById("pickerShowCalling").addEventListener("change", renderPickerList);
  window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeTeacherPicker(); });

  function renderPickerList(){
    const q = document.getElementById("pickerSearch").value.trim().toLowerCase();
    const showCalling = document.getElementById("pickerShowCalling").checked;
    const list = document.getElementById("pickerList");
    const arr = pickerState.teachers.filter(t=>{
      if(!t || !t.name || !String(t.name).trim()) return false;
      if(!t.active) return false;
      if(!showCalling && t.hasCalling) return false;
      const hay = [(t.name||""),(t.email||""),(t.phone||"").replace(/\D+/g,"")].join(" ").toLowerCase();
      return hay.includes(q);
    }).sort((a,b)=>(a.name||"").localeCompare(b.name||""));

    list.innerHTML = arr.map(t=>{
      const lastT = t.lastTaught ? fmtDate(t.lastTaught.toDate ? t.lastTaught.toDate() : t.lastTaught) : "—";
      const lastA = t.lastAsked ? fmtDate(t.lastAsked.toDate ? t.lastAsked.toDate() : t.lastAsked) : "—";
      const calling = t.hasCalling ? `<span class="pill amber" style="margin-left:6px">Has calling</span>`:"";
      const bench = (t.tags||[]).includes("Bench") ? `<span class="pill green" style="margin-left:6px">Bench</span>`:"";
      return `
        <div class="item">
          <div>
            <div><b>${t.name}:</b> <span class="meta">Last taught ${lastT} • Last asked ${lastA}</span> ${calling} ${bench}</div>
            <div class="meta">${t.email||""} ${t.phone? "• "+t.phone:""}</div>
          </div>
          <div class="row">
            <button class="btn primary" onclick="pickerAsk('${t.id}')">Ask (SMS)</button>
            <button class="btn" onclick="pickerAssign('${t.id}')">Assign only</button>
          </div>
        </div>`;
    }).join("") || `<div class="muted small">No matches.</div>`;
  }
  window.pickerAsk = async (teacherId)=>{ const id=pickerState.assignmentId; closeTeacherPicker(); await askTeacher(teacherId, id); };
  window.pickerAssign = async (teacherId)=>{
    const id = pickerState.assignmentId; if(!id) return;
    const tSnap = await getDoc(doc(colTeachers(), teacherId)); const t=tSnap.exists()? tSnap.data(): {};
    await setDoc(doc(colAssignments(), id), {
      teacherIds:[teacherId],
      teacherNames:[t.name||teacherId],
      status:"Confirmed",
      askedAt:new Date(),
      confirmedAt:new Date(),
      pendingTeacherIds:[],
      pendingTeacherNames:[]
    }, {merge:true});
    closeTeacherPicker(); renderAll();
  };

  async function renderAll(){ await Promise.all([renderNextUp(), renderSchedule(), renderDirectory()]); wireTouchFocus(); }

  // --- iOS keyboard helper ---
  function wireTouchFocus(){
    document.removeEventListener("touchend", _focusOnTouch, {capture:true});
    document.addEventListener("touchend", _focusOnTouch, {passive:true, capture:true});
  }
  function _focusOnTouch(e){
    const t = e.target;
    if(!t) return;
    if(t.tagName==="INPUT" || t.tagName==="TEXTAREA" || t.tagName==="SELECT"){
      if(document.activeElement !== t){
        try { t.focus({preventScroll:true}); } catch(_) { t.focus(); }
      }
    }
  }
  wireTouchFocus();

  if("serviceWorker" in navigator){ navigator.serviceWorker.register("sw.js?v=3").catch(()=>{}); }
</script>
</body>
</html>
